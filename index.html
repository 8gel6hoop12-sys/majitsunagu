<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<meta name="theme-color" content="#2563eb">
<title>マジつなぐ</title>

<!-- PWA / アイコン（前回のまま） -->
<link rel="manifest" href="./manifest.webmanifest">
<link rel="apple-touch-icon" href="./icons/app-icon.png">
<link rel="icon" type="image/png" href="./icons/app-icon.png">

<style>
/* ==== ベース ==== */
*,*::before,*::after{box-sizing:border-box}
html,body{margin:0;padding:0}
:root{--bg:#f7f9fc;--surface:#fff;--text:#0f172a;--muted:#64748b;--primary:#2563eb;--primary-weak:#e8f0ff;--border:#e5e7eb;--radius:18px;--shadow:0 10px 28px rgba(2,6,23,.08);--container:1000px}
body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;color:var(--text);background:var(--bg);line-height:1.6}
.container{width:min(100% - 1.5rem, var(--container));margin-inline:auto}

/* ==== ヘッダー ==== */
.header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--border);z-index:20}
.header-in{display:flex;gap:.75rem;align-items:center;justify-content:space-between;padding:.8rem 0}
.brand{display:flex;gap:.6rem;align-items:center}
.brand .dot{width:28px;height:28px;border-radius:8px;background:linear-gradient(135deg,var(--primary),#60a5fa)}
.brand strong{font-weight:800}
.iconbtn{display:inline-flex;width:42px;height:42px;border-radius:12px;align-items:center;justify-content:center;border:1px solid var(--border);background:#fff;cursor:pointer}
.iconbtn:active{transform:scale(.98)}
.menu{position:fixed;top:60px;right:1rem;background:#fff;border:1px solid var(--border);border-radius:14px;box-shadow:var(--shadow);min-width:240px;display:none;overflow:hidden}
.menu.show{display:block}
.menu a,.menu button{display:flex;width:100%;gap:.6rem;align-items:center;padding:.8rem 1rem;border:0;background:#fff;text-align:left;cursor:pointer}
.menu a:hover,.menu button:hover{background:#f8fbff}
.badge{display:inline-block;padding:.15rem .5rem;border-radius:999px;background:var(--primary-weak);border:1px solid #d9e7ff;color:var(--primary);font-size:.8rem}

/* ==== コンポーネント ==== */
.btn{display:inline-flex;align-items:center;gap:.4rem;padding:.6rem 1rem;border-radius:12px;border:1px solid var(--primary);color:var(--primary);background:#fff;cursor:pointer}
.btn--fill{background:var(--primary);color:#fff;border-color:var(--primary);box-shadow:0 6px 16px rgba(37,99,235,.25)}
.card{background:#fff;border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:1rem 1.2rem}
.small{color:var(--muted);font-size:.92rem}
.grid{display:grid;grid-template-columns:1fr;gap:1rem}
.photo{position:relative;overflow:hidden;border-radius:18px;background:#e5e7eb;min-height:360px}
.photo img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
.overlay{position:absolute;left:0;right:0;bottom:0;padding:18px;background:linear-gradient(180deg,rgba(0,0,0,0) 20%,rgba(0,0,0,.6) 80%);color:#fff}
.overlay .ttl{margin:0 0 6px;font-weight:800}
.overlay .meta{display:flex;gap:.4rem;flex-wrap:wrap}

/* ==== 入力 ==== */
.input, .select, .textarea{padding:.75rem .9rem;border:1px solid var(--border);border-radius:10px;background:#fff}
.row{display:grid;grid-template-columns:1fr 1fr 1fr auto;gap:.5rem}
@media(max-width:900px){.row{grid-template-columns:1fr 1fr}}
.formgrid{display:grid;grid-template-columns:1fr 1fr;gap:.6rem}
@media(max-width:700px){.formgrid{grid-template-columns:1fr}}

/* ==== モーダル ==== */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;padding:12px;z-index:30}
.modal .box{background:#fff;border-radius:16px;max-width:920px;width:100%;max-height:90vh;overflow:auto;padding:16px}

/* ==== テーブル ==== */
.table{width:100%;border-collapse:separate;border-spacing:0 8px}
.table th{font-size:.9rem;color:var(--muted);text-align:left;padding:.25rem .5rem}
.table td{padding:.6rem .7rem;background:#fff;border:1px solid var(--border)}

/* ==== ステータスピル ==== */
.pill{display:inline-flex;gap:.35rem;align-items:center;padding:.22rem .6rem;border-radius:999px;border:1px solid var(--border);font-size:.82rem;background:#fff}
.pill--ok{border-color:#16a34a;color:#16a34a}
.pill--warn{border-color:#f59e0b;color:#b45309}

/* 小さめの「投稿したい会社はこちら」「運営側はこちら」 */
.quickbar{display:flex;gap:.5rem;flex-wrap:wrap;margin:.6rem 0}
.quickbar a{font-size:.9rem}
</style>
</head>
<body>
<header class="header">
  <div class="container header-in">
    <div class="brand"><div class="dot"></div><strong>マジつなぐ</strong></div>
    <div style="display:flex;gap:.5rem;align-items:center">
      <span class="pill pill--ok" id="attendCountPill" title="参加したイベント数">参加 0</span>
      <button id="menuBtn" class="iconbtn" aria-label="メニュー" title="メニュー">
        <!-- ハンバーガー -->
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none"><path d="M3 6h18M3 12h18M3 18h18" stroke="#0f172a" stroke-width="2" stroke-linecap="round"/></svg>
      </button>
    </div>
  </div>
  <!-- ドロップダウンメニュー -->
  <nav class="menu" id="menu">
    <button data-view="list">🔎 探す</button>
    <button data-view="submit-company">🏢 投稿したい会社はこちら</button>
    <button data-view="attended">✅ 参加したイベント</button>
    <button data-view="admin">🛠️ 運営側はこちら</button>
  </nav>
</header>

<main class="container" style="padding:16px 0 28px">
  <!-- クイックリンク（小さめ） -->
  <div class="quickbar">
    <a href="#" data-view="submit-company" class="badge">投稿したい会社はこちら</a>
    <a href="#" data-view="admin" class="badge">運営側はこちら</a>
  </div>

  <!-- 探す -->
  <section id="view-list">
    <div class="card" style="margin-bottom:12px">
      <h2 style="margin:.2rem 0">イベントを探す</h2>
      <form id="searchForm" class="row">
        <input id="q" class="input" placeholder="キーワード">
        <select id="category" class="select">
          <option value="">カテゴリ</option><option>キャリア</option><option>コミュニティ</option><option>勉強会</option><option>交流</option><option>その他</option>
        </select>
        <select id="mode" class="select">
          <option value="">形式</option><option>オンライン</option><option>オフライン</option><option>ハイブリッド</option>
        </select>
        <button class="btn btn--fill" type="submit">絞り込み</button>
      </form>
      <div class="small" style="margin-top:.4rem">※ 承認済みのみ表示。右上メニューの「参加したイベント」から確認できます。</div>
    </div>

    <div id="cards" class="grid"></div>
  </section>

  <!-- 会社投稿（一般・パス不要） -->
  <section id="view-submit-company" style="display:none">
    <div class="card">
      <h2 style="margin:.2rem 0">企業・団体の方の投稿</h2>
      <p class="small">イベント情報を入力して送信してください。運営側の承認後に公開されます。</p>
      <form id="submitForm" style="display:grid;gap:.6rem">
        <div class="formgrid">
          <input name="title" class="input" placeholder="★ タイトル" required>
          <select name="category" class="select"><option value="">カテゴリ</option><option>キャリア</option><option>コミュニティ</option><option>勉強会</option><option>交流</option><option>その他</option></select>
          <input name="organizer" class="input" placeholder="主催">
          <input type="date" name="date" class="input">
          <input name="time" class="input" placeholder="時間 18:00-20:00">
          <input name="location" class="input" placeholder="場所（渋谷/Zoom など）">
          <select name="mode" class="select"><option value="">形式</option><option>オンライン</option><option>オフライン</option><option>ハイブリッド</option></select>
          <input name="price" class="input" placeholder="参加費（無料/学割 など）">
          <input name="capacity" class="input" placeholder="定員（先着50名 など）">
          <input name="tags" class="input" placeholder="タグ（LT,交流 など）">
        </div>
        <textarea name="summary" class="textarea" rows="3" placeholder="★ 概要（1〜3行）" required></textarea>
        <textarea name="details" class="textarea" rows="4" placeholder="詳細（任意）"></textarea>
        <input name="applyUrl" class="input" placeholder="申込URL（任意）">
        <div class="small">画像（1枚）</div>
        <input type="file" id="fileInput" name="image" accept="image/*">
        <div style="display:flex;gap:.6rem;flex-wrap:wrap;align-items:center">
          <button class="btn btn--fill" type="submit">保存（承認待ち）</button>
          <span class="small">送信後、運営側で承認すると公開されます。</span>
        </div>
      </form>
    </div>
  </section>

  <!-- 参加したイベント -->
  <section id="view-attended" style="display:none">
    <div class="card">
      <h2 style="margin:.2rem 0">参加したイベント</h2>
      <div id="attendedList" class="grid"></div>
    </div>
  </section>

  <!-- 運営（パスワード保護） -->
  <section id="view-admin" style="display:none">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:1rem">
        <h2 style="margin:.2rem 0">運営ダッシュボード</h2>
        <span class="pill pill--warn">パスワードで保護</span>
      </div>
      <table class="table" id="adminTable">
        <thead><tr><th>承認</th><th>基本</th><th>日付/時間</th><th>場所</th><th>操作</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>
</main>

<!-- 詳細モーダル -->
<div class="modal" id="modal">
  <div class="box">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:1rem">
      <h3 id="m-title" style="margin:.2rem 0"></h3>
      <div style="display:flex;gap:.5rem;align-items:center">
        <button class="btn" id="m-attend">参加する</button>
        <button class="btn" id="m-close">閉じる</button>
      </div>
    </div>
    <div id="m-body"></div>
  </div>
</div>

<!-- パスワードモーダル -->
<div class="modal" id="pwModal">
  <div class="box" style="max-width:420px">
    <h3 style="margin-top:0">運営ログイン</h3>
    <p class="small">8桁の英数字パスワードを入力してください。</p>
    <input id="pwInput" class="input" placeholder="パスワード" maxlength="32" autocomplete="current-password" type="password" style="width:100%;margin-bottom:.8rem">
    <div style="display:flex;gap:.6rem;justify-content:flex-end">
      <button class="btn" id="pwCancel">キャンセル</button>
      <button class="btn btn--fill" id="pwOk">ログイン</button>
    </div>
  </div>
</div>

<script>
/* ================== 設定 ================== */
const ADMIN_PASS = "A7B9C3D1"; // ★ 8桁英数字（ここを変更でOK）
const KEY_EVENTS = "majitsunagu-v1";
const KEY_ATTEND = "majitsunagu-attend";
const KEY_ADMIN_SESSION = "majitsunagu-admin-session";

/* ================== ストレージ ================== */
const loadEvents = () => JSON.parse(localStorage.getItem(KEY_EVENTS) || "[]");
const saveEvents = (arr) => localStorage.setItem(KEY_EVENTS, JSON.stringify(arr));
const loadAttend = () => JSON.parse(localStorage.getItem(KEY_ATTEND) || "[]");
const saveAttend = (arr) => localStorage.setItem(KEY_ATTEND, JSON.stringify(arr));

/* ================== ビュー切替（メニュー） ================== */
const views = ["list","submit-company","attended","admin"];
function showView(name){
  views.forEach(v => document.getElementById("view-"+v).style.display = (v===name?"":"none"));
  // 付随処理
  if(name==="list") renderList();
  if(name==="attended") renderAttended();
  if(name==="admin") ensureAdmin().then(ok=>{ if(ok){ renderAdmin(); } else { showView("list"); }});
  closeMenu();
}
const menuBtn = document.getElementById('menuBtn');
const menu = document.getElementById('menu');
function closeMenu(){ menu.classList.remove('show'); }
menuBtn.addEventListener('click', (e)=>{ e.stopPropagation(); menu.classList.toggle('show'); });
document.addEventListener('click', (e)=>{ if(!menu.contains(e.target) && e.target!==menuBtn){ closeMenu(); }});
menu.addEventListener('click', (e)=>{
  const btn = e.target.closest('[data-view]'); if(!btn) return;
  e.preventDefault(); showView(btn.dataset.view);
});
document.querySelectorAll('.quickbar [data-view]').forEach(a=>{
  a.addEventListener('click', (e)=>{ e.preventDefault(); showView(a.dataset.view); });
});

/* ================== 検索 & 一覧 ================== */
function renderList(){
  const q=document.getElementById('q').value.trim().toLowerCase();
  const cat=document.getElementById('category').value;
  const mode=document.getElementById('mode').value;
  const wrap=document.getElementById('cards'); wrap.innerHTML="";
  const attending = new Set(loadAttend());
  const items=loadEvents().filter(e=>e.approved);
  const filtered=items.filter(e=>{
    const text=[e.title,e.organizer,e.summary,e.tags].join(' ').toLowerCase();
    const hit=!q||text.includes(q);
    const hc=!cat||e.category===cat;
    const hm=!mode||e.mode===mode;
    return hit&&hc&&hm;
  }).sort((a,b)=>String(a.date).localeCompare(b.date));
  if(!filtered.length){ wrap.innerHTML='<p class="small">該当するイベントがありません。</p>'; return; }
  filtered.forEach(ev=>{
    const f=document.createElement('figure'); f.className='photo';
    f.innerHTML=`
      ${ev.image?`<img src="${ev.image}" alt="">`:`<svg viewBox="0 0 16 9" style="position:absolute;inset:0;width:100%;height:100%"><rect width="16" height="9" fill="#e5e7eb"/></svg>`}
      <figcaption class="overlay">
        <p class="ttl" style="display:flex;align-items:center;gap:.5rem">
          ${ev.title}
          ${attending.has(String(ev.id))?'<span class="pill pill--ok">参加中</span>':''}
        </p>
        <div class="meta">
          <span class="badge">${ev.category||'イベント'}</span>
          <span class="badge">${ev.mode||'-'}</span>
          ${ev.location?`<span class="badge">${ev.location}</span>`:''}
          <span class="badge">${ev.date||''}${ev.time?` ${ev.time}`:''}</span>
        </div>
      </figcaption>
      <a href="#" data-id="${ev.id}" class="open-detail" style="position:absolute;inset:0"></a>
    `;
    wrap.appendChild(f);
  });
  updateAttendCount();
}
document.getElementById('searchForm').addEventListener('submit', e=>{ e.preventDefault(); renderList(); });

/* ================== 詳細モーダル & 参加トグル ================== */
const modal=document.getElementById('modal');
const mClose=document.getElementById('m-close');
const mAttend=document.getElementById('m-attend');
let currentEventId=null;
document.addEventListener('click', e=>{
  const a=e.target.closest('a.open-detail'); if(!a) return;
  e.preventDefault();
  const id=a.dataset.id; currentEventId=id;
  const ev=loadEvents().find(x=>String(x.id)===String(id)); if(!ev) return;
  document.getElementById('m-title').textContent=ev.title;
  const attending = new Set(loadAttend());
  mAttend.textContent = attending.has(String(id)) ? "参加をやめる" : "参加する";
  document.getElementById('m-body').innerHTML=`
    ${ev.image?`<img src="${ev.image}" style="width:100%;height:480px;object-fit:cover;border-radius:12px;margin-bottom:.6rem">`:''}
    <div class="small" style="margin-bottom:.4rem">
      <span class="badge">${ev.category||'イベント'}</span>
      <span class="badge">${ev.mode||'-'}</span>
      ${ev.location?`<span class="badge">${ev.location}</span>`:''}
    </div>
    <ul class="small" style="display:flex;gap:.8rem;flex-wrap:wrap;margin:.2rem 0 1rem;color:#334155">
      <li>${ev.date||''} ${ev.time||''}</li>
      <li>主催：${ev.organizer||''}</li>
      <li>参加費：${ev.price||'無料/未定'}</li>
      <li>定員：${ev.capacity||'未定'}</li>
      ${ev.tags?`<li>タグ：${ev.tags}</li>`:''}
    </ul>
    <h3>詳細</h3>
    <div style="white-space:pre-wrap;background:#fbfdff;border:1px solid var(--border);padding:.8rem;border-radius:10px">${(ev.details||ev.summary||'').replace(/&/g,'&amp;').replace(/</g,'&lt;')}</div>
    ${ev.applyUrl?`<p style="margin-top:.8rem"><a class="btn btn--fill" href="${ev.applyUrl}" target="_blank" rel="noopener">申込ページへ</a></p>`:''}
  `;
  modal.style.display='flex';
});
mClose.onclick=()=> modal.style.display='none';
mAttend.onclick=()=>{
  if(!currentEventId) return;
  const set = new Set(loadAttend());
  if(set.has(String(currentEventId))){ set.delete(String(currentEventId)); }
  else { set.add(String(currentEventId)); }
  saveAttend(Array.from(set));
  updateAttendCount();
  renderList();
  // ボタン表示更新
  mAttend.textContent = set.has(String(currentEventId)) ? "参加をやめる" : "参加する";
};

/* ================== 参加一覧 ================== */
function renderAttended(){
  const ids = new Set(loadAttend());
  const all = loadEvents();
  const list = all.filter(ev => ids.has(String(ev.id)));
  const wrap = document.getElementById('attendedList'); wrap.innerHTML="";
  if(!list.length){ wrap.innerHTML='<p class="small">参加登録したイベントはまだありません。</p>'; return; }
  list.sort((a,b)=>String(a.date).localeCompare(b.date));
  list.forEach(ev=>{
    const f=document.createElement('figure'); f.className='photo';
    f.innerHTML=`
      ${ev.image?`<img src="${ev.image}" alt="">`:`<svg viewBox="0 0 16 9" style="position:absolute;inset:0;width:100%;height:100%"><rect width="16" height="9" fill="#e5e7eb"/></svg>`}
      <figcaption class="overlay">
        <p class="ttl">${ev.title}</p>
        <div class="meta">
          <span class="badge">${ev.category||'イベント'}</span>
          ${ev.location?`<span class="badge">${ev.location}</span>`:''}
          <span class="badge">${ev.date||''}${ev.time?` ${ev.time}`:''}</span>
        </div>
      </figcaption>
      <a href="#" data-id="${ev.id}" class="open-detail" style="position:absolute;inset:0"></a>
    `;
    wrap.appendChild(f);
  });
}
function updateAttendCount(){
  const n = loadAttend().length;
  document.getElementById('attendCountPill').textContent = `参加 ${n}`;
}

/* ================== 会社投稿 ================== */
document.getElementById('submitForm').addEventListener('submit', async e=>{
  e.preventDefault();
  const f=new FormData(e.currentTarget);
  const file=document.getElementById('fileInput').files[0];
  const imgData=file?await new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); }):"";
  const arr=loadEvents();
  arr.push({
    id:Date.now(), title:f.get('title')||'', category:f.get('category')||'',
    organizer:f.get('organizer')||'', date:f.get('date')||'', time:f.get('time')||'',
    location:f.get('location')||'', mode:f.get('mode')||'', price:f.get('price')||'',
    capacity:f.get('capacity')||'', tags:f.get('tags')||'',
    summary:f.get('summary')||'', details:f.get('details')||'',
    applyUrl:f.get('applyUrl')||'', image:imgData, approved:false
  });
  saveEvents(arr);
  alert('送信しました。運営側の承認後に公開されます。');
  e.currentTarget.reset();
});

/* ================== 運営（パスワード） ================== */
const pwModal = document.getElementById('pwModal');
const pwInput = document.getElementById('pwInput');
document.getElementById('pwCancel').onclick=()=>{ pwModal.style.display='none'; };
document.getElementById('pwOk').onclick=()=>{
  if(pwInput.value===ADMIN_PASS){
    sessionStorage.setItem(KEY_ADMIN_SESSION, "1");
    pwModal.style.display='none';
    renderAdmin();
  }else{
    alert('パスワードが違います');
  }
};
function ensureAdmin(){
  // 既にセッションOKなら true
  if(sessionStorage.getItem(KEY_ADMIN_SESSION)==="1"){ return Promise.resolve(true); }
  // 入力モーダル表示
  pwInput.value=""; pwModal.style.display='flex';
  // ユーザー操作の結果をPromiseで待つ
  return new Promise(resolve=>{
    const onHide=()=>{
      pwModal.style.display='none';
      document.removeEventListener('admin-auth-success', onSuccess);
      resolve(sessionStorage.getItem(KEY_ADMIN_SESSION)==="1");
    };
    const onSuccess=()=>{ resolve(true); };
    document.getElementById('pwCancel').addEventListener('click', onHide, {once:true});
    document.getElementById('pwOk').addEventListener('click', ()=>{ if(sessionStorage.getItem(KEY_ADMIN_SESSION)==="1"){ onSuccess(); }}, {once:true});
  });
}

/* ================== 運営テーブル ================== */
function renderAdmin(){
  document.getElementById('view-admin').style.display='';
  const tbody=document.querySelector('#adminTable tbody'); tbody.innerHTML='';
  loadEvents().sort((a,b)=>String(a.date).localeCompare(b.date)).forEach(ev=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td><input type="checkbox" ${ev.approved?'checked':''} data-act="approve" data-id="${ev.id}"></td>
      <td><strong>${ev.title}</strong><div class="small">主催：${ev.organizer||''}</div>
        <div class="small" style="margin-top:.25rem"><span class="badge">${ev.category||''}</span> <span class="badge">${ev.mode||''}</span></div></td>
      <td>${ev.date||''} ${ev.time||''}</td>
      <td>${ev.location||''}</td>
      <td style="display:flex;gap:.4rem;flex-wrap:wrap">
        <button class="btn" data-act="delete" data-id="${ev.id}">削除</button>
      </td>`;
    tbody.appendChild(tr);
  });
}
document.getElementById('view-admin').addEventListener('change', e=>{
  const t=e.target;
  if(t.dataset.act==='approve'){
    const arr=loadEvents(); const ev=arr.find(x=>String(x.id)===t.dataset.id);
    if(ev){ ev.approved=t.checked; saveEvents(arr); renderList(); }
  }
});
document.getElementById('view-admin').addEventListener('click', e=>{
  const btn=e.target.closest('button[data-act="delete"]'); if(!btn) return;
  if(!confirm('削除しますか？')) return;
  const arr=loadEvents().filter(x=>String(x.id)!==btn.dataset.id); saveEvents(arr);
  renderAdmin(); renderList();
});

/* ================== 初期データ & 初期描画 ================== */
if(loadEvents().length===0){
  const today=new Date().toISOString().slice(0,10);
  saveEvents([{ id:Date.now()-1, title:"就活スタートダッシュ相談会", category:"キャリア", organizer:"Career Lab",
    date:today, time:"18:00-19:30", location:"オンライン", mode:"オンライン",
    price:"無料", capacity:"先着50名", tags:"面接,ES,自己分析",
    summary:"面談のコツやES添削ポイントをQ&A形式で紹介。", details:"元メガベン出身メンターが丁寧に解説。",
    applyUrl:"https://example.com/apply", image:"", approved:true }]);
}
renderList();
updateAttendCount();

/* ================== SW登録 ================== */
if('serviceWorker' in navigator){ window.addEventListener('load',()=>navigator.serviceWorker.register('./sw.js')); }
</script>
</body>
</html>
