<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<meta name="theme-color" content="#2563eb">
<title>ãƒã‚¸ã¤ãªã</title>

<!-- PWA / ã‚¢ã‚¤ã‚³ãƒ³ï¼ˆå‰å›ã®ã¾ã¾ï¼‰ -->
<link rel="manifest" href="./manifest.webmanifest">
<link rel="apple-touch-icon" href="./icons/app-icon.png">
<link rel="icon" type="image/png" href="./icons/app-icon.png">

<style>
/* ==== ãƒ™ãƒ¼ã‚¹ ==== */
*,*::before,*::after{box-sizing:border-box}
html,body{margin:0;padding:0}
:root{--bg:#f7f9fc;--surface:#fff;--text:#0f172a;--muted:#64748b;--primary:#2563eb;--primary-weak:#e8f0ff;--border:#e5e7eb;--radius:18px;--shadow:0 10px 28px rgba(2,6,23,.08);--container:1000px}
body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;color:var(--text);background:var(--bg);line-height:1.6}
.container{width:min(100% - 1.5rem, var(--container));margin-inline:auto}

/* ==== ãƒ˜ãƒƒãƒ€ãƒ¼ ==== */
.header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--border);z-index:20}
.header-in{display:flex;gap:.75rem;align-items:center;justify-content:space-between;padding:.8rem 0}
.brand{display:flex;gap:.6rem;align-items:center}
.brand .dot{width:28px;height:28px;border-radius:8px;background:linear-gradient(135deg,var(--primary),#60a5fa)}
.brand strong{font-weight:800}
.iconbtn{display:inline-flex;width:42px;height:42px;border-radius:12px;align-items:center;justify-content:center;border:1px solid var(--border);background:#fff;cursor:pointer}
.iconbtn:active{transform:scale(.98)}
.menu{position:fixed;top:60px;right:1rem;background:#fff;border:1px solid var(--border);border-radius:14px;box-shadow:var(--shadow);min-width:240px;display:none;overflow:hidden}
.menu.show{display:block}
.menu a,.menu button{display:flex;width:100%;gap:.6rem;align-items:center;padding:.8rem 1rem;border:0;background:#fff;text-align:left;cursor:pointer}
.menu a:hover,.menu button:hover{background:#f8fbff}
.badge{display:inline-block;padding:.15rem .5rem;border-radius:999px;background:var(--primary-weak);border:1px solid #d9e7ff;color:var(--primary);font-size:.8rem}

/* ==== ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ ==== */
.btn{display:inline-flex;align-items:center;gap:.4rem;padding:.6rem 1rem;border-radius:12px;border:1px solid var(--primary);color:var(--primary);background:#fff;cursor:pointer}
.btn--fill{background:var(--primary);color:#fff;border-color:var(--primary);box-shadow:0 6px 16px rgba(37,99,235,.25)}
.card{background:#fff;border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:1rem 1.2rem}
.small{color:var(--muted);font-size:.92rem}
.grid{display:grid;grid-template-columns:1fr;gap:1rem}
.photo{position:relative;overflow:hidden;border-radius:18px;background:#e5e7eb;min-height:360px}
.photo img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
.overlay{position:absolute;left:0;right:0;bottom:0;padding:18px;background:linear-gradient(180deg,rgba(0,0,0,0) 20%,rgba(0,0,0,.6) 80%);color:#fff}
.overlay .ttl{margin:0 0 6px;font-weight:800}
.overlay .meta{display:flex;gap:.4rem;flex-wrap:wrap}

/* ==== å…¥åŠ› ==== */
.input, .select, .textarea{padding:.75rem .9rem;border:1px solid var(--border);border-radius:10px;background:#fff}
.row{display:grid;grid-template-columns:1fr 1fr 1fr auto;gap:.5rem}
@media(max-width:900px){.row{grid-template-columns:1fr 1fr}}
.formgrid{display:grid;grid-template-columns:1fr 1fr;gap:.6rem}
@media(max-width:700px){.formgrid{grid-template-columns:1fr}}

/* ==== ãƒ¢ãƒ¼ãƒ€ãƒ« ==== */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;padding:12px;z-index:30}
.modal .box{background:#fff;border-radius:16px;max-width:920px;width:100%;max-height:90vh;overflow:auto;padding:16px}

/* ==== ãƒ†ãƒ¼ãƒ–ãƒ« ==== */
.table{width:100%;border-collapse:separate;border-spacing:0 8px}
.table th{font-size:.9rem;color:var(--muted);text-align:left;padding:.25rem .5rem}
.table td{padding:.6rem .7rem;background:#fff;border:1px solid var(--border)}

/* ==== ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ”ãƒ« ==== */
.pill{display:inline-flex;gap:.35rem;align-items:center;padding:.22rem .6rem;border-radius:999px;border:1px solid var(--border);font-size:.82rem;background:#fff}
.pill--ok{border-color:#16a34a;color:#16a34a}
.pill--warn{border-color:#f59e0b;color:#b45309}

/* å°ã•ã‚ã®ã€ŒæŠ•ç¨¿ã—ãŸã„ä¼šç¤¾ã¯ã“ã¡ã‚‰ã€ã€Œé‹å–¶å´ã¯ã“ã¡ã‚‰ã€ */
.quickbar{display:flex;gap:.5rem;flex-wrap:wrap;margin:.6rem 0}
.quickbar a{font-size:.9rem}
</style>
</head>
<body>
<header class="header">
  <div class="container header-in">
    <div class="brand"><div class="dot"></div><strong>ãƒã‚¸ã¤ãªã</strong></div>
    <div style="display:flex;gap:.5rem;align-items:center">
      <span class="pill pill--ok" id="attendCountPill" title="å‚åŠ ã—ãŸã‚¤ãƒ™ãƒ³ãƒˆæ•°">å‚åŠ  0</span>
      <button id="menuBtn" class="iconbtn" aria-label="ãƒ¡ãƒ‹ãƒ¥ãƒ¼" title="ãƒ¡ãƒ‹ãƒ¥ãƒ¼">
        <!-- ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ -->
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none"><path d="M3 6h18M3 12h18M3 18h18" stroke="#0f172a" stroke-width="2" stroke-linecap="round"/></svg>
      </button>
    </div>
  </div>
  <!-- ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
  <nav class="menu" id="menu">
    <button data-view="list">ğŸ” æ¢ã™</button>
    <button data-view="submit-company">ğŸ¢ æŠ•ç¨¿ã—ãŸã„ä¼šç¤¾ã¯ã“ã¡ã‚‰</button>
    <button data-view="attended">âœ… å‚åŠ ã—ãŸã‚¤ãƒ™ãƒ³ãƒˆ</button>
    <button data-view="admin">ğŸ› ï¸ é‹å–¶å´ã¯ã“ã¡ã‚‰</button>
  </nav>
</header>

<main class="container" style="padding:16px 0 28px">
  <!-- ã‚¯ã‚¤ãƒƒã‚¯ãƒªãƒ³ã‚¯ï¼ˆå°ã•ã‚ï¼‰ -->
  <div class="quickbar">
    <a href="#" data-view="submit-company" class="badge">æŠ•ç¨¿ã—ãŸã„ä¼šç¤¾ã¯ã“ã¡ã‚‰</a>
    <a href="#" data-view="admin" class="badge">é‹å–¶å´ã¯ã“ã¡ã‚‰</a>
  </div>

  <!-- æ¢ã™ -->
  <section id="view-list">
    <div class="card" style="margin-bottom:12px">
      <h2 style="margin:.2rem 0">ã‚¤ãƒ™ãƒ³ãƒˆã‚’æ¢ã™</h2>
      <form id="searchForm" class="row">
        <input id="q" class="input" placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰">
        <select id="category" class="select">
          <option value="">ã‚«ãƒ†ã‚´ãƒª</option><option>ã‚­ãƒ£ãƒªã‚¢</option><option>ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£</option><option>å‹‰å¼·ä¼š</option><option>äº¤æµ</option><option>ãã®ä»–</option>
        </select>
        <select id="mode" class="select">
          <option value="">å½¢å¼</option><option>ã‚ªãƒ³ãƒ©ã‚¤ãƒ³</option><option>ã‚ªãƒ•ãƒ©ã‚¤ãƒ³</option><option>ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰</option>
        </select>
        <button class="btn btn--fill" type="submit">çµã‚Šè¾¼ã¿</button>
      </form>
      <div class="small" style="margin-top:.4rem">â€» æ‰¿èªæ¸ˆã¿ã®ã¿è¡¨ç¤ºã€‚å³ä¸Šãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ã€Œå‚åŠ ã—ãŸã‚¤ãƒ™ãƒ³ãƒˆã€ã‹ã‚‰ç¢ºèªã§ãã¾ã™ã€‚</div>
    </div>

    <div id="cards" class="grid"></div>
  </section>

  <!-- ä¼šç¤¾æŠ•ç¨¿ï¼ˆä¸€èˆ¬ãƒ»ãƒ‘ã‚¹ä¸è¦ï¼‰ -->
  <section id="view-submit-company" style="display:none">
    <div class="card">
      <h2 style="margin:.2rem 0">ä¼æ¥­ãƒ»å›£ä½“ã®æ–¹ã®æŠ•ç¨¿</h2>
      <p class="small">ã‚¤ãƒ™ãƒ³ãƒˆæƒ…å ±ã‚’å…¥åŠ›ã—ã¦é€ä¿¡ã—ã¦ãã ã•ã„ã€‚é‹å–¶å´ã®æ‰¿èªå¾Œã«å…¬é–‹ã•ã‚Œã¾ã™ã€‚</p>
      <form id="submitForm" style="display:grid;gap:.6rem">
        <div class="formgrid">
          <input name="title" class="input" placeholder="â˜… ã‚¿ã‚¤ãƒˆãƒ«" required>
          <select name="category" class="select"><option value="">ã‚«ãƒ†ã‚´ãƒª</option><option>ã‚­ãƒ£ãƒªã‚¢</option><option>ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£</option><option>å‹‰å¼·ä¼š</option><option>äº¤æµ</option><option>ãã®ä»–</option></select>
          <input name="organizer" class="input" placeholder="ä¸»å‚¬">
          <input type="date" name="date" class="input">
          <input name="time" class="input" placeholder="æ™‚é–“ 18:00-20:00">
          <input name="location" class="input" placeholder="å ´æ‰€ï¼ˆæ¸‹è°·/Zoom ãªã©ï¼‰">
          <select name="mode" class="select"><option value="">å½¢å¼</option><option>ã‚ªãƒ³ãƒ©ã‚¤ãƒ³</option><option>ã‚ªãƒ•ãƒ©ã‚¤ãƒ³</option><option>ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰</option></select>
          <input name="price" class="input" placeholder="å‚åŠ è²»ï¼ˆç„¡æ–™/å­¦å‰² ãªã©ï¼‰">
          <input name="capacity" class="input" placeholder="å®šå“¡ï¼ˆå…ˆç€50å ãªã©ï¼‰">
          <input name="tags" class="input" placeholder="ã‚¿ã‚°ï¼ˆLT,äº¤æµ ãªã©ï¼‰">
        </div>
        <textarea name="summary" class="textarea" rows="3" placeholder="â˜… æ¦‚è¦ï¼ˆ1ã€œ3è¡Œï¼‰" required></textarea>
        <textarea name="details" class="textarea" rows="4" placeholder="è©³ç´°ï¼ˆä»»æ„ï¼‰"></textarea>
        <input name="applyUrl" class="input" placeholder="ç”³è¾¼URLï¼ˆä»»æ„ï¼‰">
        <div class="small">ç”»åƒï¼ˆ1æšï¼‰</div>
        <input type="file" id="fileInput" name="image" accept="image/*">
        <div style="display:flex;gap:.6rem;flex-wrap:wrap;align-items:center">
          <button class="btn btn--fill" type="submit">ä¿å­˜ï¼ˆæ‰¿èªå¾…ã¡ï¼‰</button>
          <span class="small">é€ä¿¡å¾Œã€é‹å–¶å´ã§æ‰¿èªã™ã‚‹ã¨å…¬é–‹ã•ã‚Œã¾ã™ã€‚</span>
        </div>
      </form>
    </div>
  </section>

  <!-- å‚åŠ ã—ãŸã‚¤ãƒ™ãƒ³ãƒˆ -->
  <section id="view-attended" style="display:none">
    <div class="card">
      <h2 style="margin:.2rem 0">å‚åŠ ã—ãŸã‚¤ãƒ™ãƒ³ãƒˆ</h2>
      <div id="attendedList" class="grid"></div>
    </div>
  </section>

  <!-- é‹å–¶ï¼ˆãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ä¿è­·ï¼‰ -->
  <section id="view-admin" style="display:none">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:1rem">
        <h2 style="margin:.2rem 0">é‹å–¶ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h2>
        <span class="pill pill--warn">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§ä¿è­·</span>
      </div>
      <table class="table" id="adminTable">
        <thead><tr><th>æ‰¿èª</th><th>åŸºæœ¬</th><th>æ—¥ä»˜/æ™‚é–“</th><th>å ´æ‰€</th><th>æ“ä½œ</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>
</main>

<!-- è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal" id="modal">
  <div class="box">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:1rem">
      <h3 id="m-title" style="margin:.2rem 0"></h3>
      <div style="display:flex;gap:.5rem;align-items:center">
        <button class="btn" id="m-attend">å‚åŠ ã™ã‚‹</button>
        <button class="btn" id="m-close">é–‰ã˜ã‚‹</button>
      </div>
    </div>
    <div id="m-body"></div>
  </div>
</div>

<!-- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal" id="pwModal">
  <div class="box" style="max-width:420px">
    <h3 style="margin-top:0">é‹å–¶ãƒ­ã‚°ã‚¤ãƒ³</h3>
    <p class="small">8æ¡ã®è‹±æ•°å­—ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
    <input id="pwInput" class="input" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" maxlength="32" autocomplete="current-password" type="password" style="width:100%;margin-bottom:.8rem">
    <div style="display:flex;gap:.6rem;justify-content:flex-end">
      <button class="btn" id="pwCancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="btn btn--fill" id="pwOk">ãƒ­ã‚°ã‚¤ãƒ³</button>
    </div>
  </div>
</div>

<script>
/* ================== è¨­å®š ================== */
const ADMIN_PASS = "A7B9C3D1"; // â˜… 8æ¡è‹±æ•°å­—ï¼ˆã“ã“ã‚’å¤‰æ›´ã§OKï¼‰
const KEY_EVENTS = "majitsunagu-v1";
const KEY_ATTEND = "majitsunagu-attend";
const KEY_ADMIN_SESSION = "majitsunagu-admin-session";

/* ================== ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ ================== */
const loadEvents = () => JSON.parse(localStorage.getItem(KEY_EVENTS) || "[]");
const saveEvents = (arr) => localStorage.setItem(KEY_EVENTS, JSON.stringify(arr));
const loadAttend = () => JSON.parse(localStorage.getItem(KEY_ATTEND) || "[]");
const saveAttend = (arr) => localStorage.setItem(KEY_ATTEND, JSON.stringify(arr));

/* ================== ãƒ“ãƒ¥ãƒ¼åˆ‡æ›¿ï¼ˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼‰ ================== */
const views = ["list","submit-company","attended","admin"];
function showView(name){
  views.forEach(v => document.getElementById("view-"+v).style.display = (v===name?"":"none"));
  // ä»˜éšå‡¦ç†
  if(name==="list") renderList();
  if(name==="attended") renderAttended();
  if(name==="admin") ensureAdmin().then(ok=>{ if(ok){ renderAdmin(); } else { showView("list"); }});
  closeMenu();
}
const menuBtn = document.getElementById('menuBtn');
const menu = document.getElementById('menu');
function closeMenu(){ menu.classList.remove('show'); }
menuBtn.addEventListener('click', (e)=>{ e.stopPropagation(); menu.classList.toggle('show'); });
document.addEventListener('click', (e)=>{ if(!menu.contains(e.target) && e.target!==menuBtn){ closeMenu(); }});
menu.addEventListener('click', (e)=>{
  const btn = e.target.closest('[data-view]'); if(!btn) return;
  e.preventDefault(); showView(btn.dataset.view);
});
document.querySelectorAll('.quickbar [data-view]').forEach(a=>{
  a.addEventListener('click', (e)=>{ e.preventDefault(); showView(a.dataset.view); });
});

/* ================== æ¤œç´¢ & ä¸€è¦§ ================== */
function renderList(){
  const q=document.getElementById('q').value.trim().toLowerCase();
  const cat=document.getElementById('category').value;
  const mode=document.getElementById('mode').value;
  const wrap=document.getElementById('cards'); wrap.innerHTML="";
  const attending = new Set(loadAttend());
  const items=loadEvents().filter(e=>e.approved);
  const filtered=items.filter(e=>{
    const text=[e.title,e.organizer,e.summary,e.tags].join(' ').toLowerCase();
    const hit=!q||text.includes(q);
    const hc=!cat||e.category===cat;
    const hm=!mode||e.mode===mode;
    return hit&&hc&&hm;
  }).sort((a,b)=>String(a.date).localeCompare(b.date));
  if(!filtered.length){ wrap.innerHTML='<p class="small">è©²å½“ã™ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>'; return; }
  filtered.forEach(ev=>{
    const f=document.createElement('figure'); f.className='photo';
    f.innerHTML=`
      ${ev.image?`<img src="${ev.image}" alt="">`:`<svg viewBox="0 0 16 9" style="position:absolute;inset:0;width:100%;height:100%"><rect width="16" height="9" fill="#e5e7eb"/></svg>`}
      <figcaption class="overlay">
        <p class="ttl" style="display:flex;align-items:center;gap:.5rem">
          ${ev.title}
          ${attending.has(String(ev.id))?'<span class="pill pill--ok">å‚åŠ ä¸­</span>':''}
        </p>
        <div class="meta">
          <span class="badge">${ev.category||'ã‚¤ãƒ™ãƒ³ãƒˆ'}</span>
          <span class="badge">${ev.mode||'-'}</span>
          ${ev.location?`<span class="badge">${ev.location}</span>`:''}
          <span class="badge">${ev.date||''}${ev.time?` ${ev.time}`:''}</span>
        </div>
      </figcaption>
      <a href="#" data-id="${ev.id}" class="open-detail" style="position:absolute;inset:0"></a>
    `;
    wrap.appendChild(f);
  });
  updateAttendCount();
}
document.getElementById('searchForm').addEventListener('submit', e=>{ e.preventDefault(); renderList(); });

/* ================== è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« & å‚åŠ ãƒˆã‚°ãƒ« ================== */
const modal=document.getElementById('modal');
const mClose=document.getElementById('m-close');
const mAttend=document.getElementById('m-attend');
let currentEventId=null;
document.addEventListener('click', e=>{
  const a=e.target.closest('a.open-detail'); if(!a) return;
  e.preventDefault();
  const id=a.dataset.id; currentEventId=id;
  const ev=loadEvents().find(x=>String(x.id)===String(id)); if(!ev) return;
  document.getElementById('m-title').textContent=ev.title;
  const attending = new Set(loadAttend());
  mAttend.textContent = attending.has(String(id)) ? "å‚åŠ ã‚’ã‚„ã‚ã‚‹" : "å‚åŠ ã™ã‚‹";
  document.getElementById('m-body').innerHTML=`
    ${ev.image?`<img src="${ev.image}" style="width:100%;height:480px;object-fit:cover;border-radius:12px;margin-bottom:.6rem">`:''}
    <div class="small" style="margin-bottom:.4rem">
      <span class="badge">${ev.category||'ã‚¤ãƒ™ãƒ³ãƒˆ'}</span>
      <span class="badge">${ev.mode||'-'}</span>
      ${ev.location?`<span class="badge">${ev.location}</span>`:''}
    </div>
    <ul class="small" style="display:flex;gap:.8rem;flex-wrap:wrap;margin:.2rem 0 1rem;color:#334155">
      <li>${ev.date||''} ${ev.time||''}</li>
      <li>ä¸»å‚¬ï¼š${ev.organizer||''}</li>
      <li>å‚åŠ è²»ï¼š${ev.price||'ç„¡æ–™/æœªå®š'}</li>
      <li>å®šå“¡ï¼š${ev.capacity||'æœªå®š'}</li>
      ${ev.tags?`<li>ã‚¿ã‚°ï¼š${ev.tags}</li>`:''}
    </ul>
    <h3>è©³ç´°</h3>
    <div style="white-space:pre-wrap;background:#fbfdff;border:1px solid var(--border);padding:.8rem;border-radius:10px">${(ev.details||ev.summary||'').replace(/&/g,'&amp;').replace(/</g,'&lt;')}</div>
    ${ev.applyUrl?`<p style="margin-top:.8rem"><a class="btn btn--fill" href="${ev.applyUrl}" target="_blank" rel="noopener">ç”³è¾¼ãƒšãƒ¼ã‚¸ã¸</a></p>`:''}
  `;
  modal.style.display='flex';
});
mClose.onclick=()=> modal.style.display='none';
mAttend.onclick=()=>{
  if(!currentEventId) return;
  const set = new Set(loadAttend());
  if(set.has(String(currentEventId))){ set.delete(String(currentEventId)); }
  else { set.add(String(currentEventId)); }
  saveAttend(Array.from(set));
  updateAttendCount();
  renderList();
  // ãƒœã‚¿ãƒ³è¡¨ç¤ºæ›´æ–°
  mAttend.textContent = set.has(String(currentEventId)) ? "å‚åŠ ã‚’ã‚„ã‚ã‚‹" : "å‚åŠ ã™ã‚‹";
};

/* ================== å‚åŠ ä¸€è¦§ ================== */
function renderAttended(){
  const ids = new Set(loadAttend());
  const all = loadEvents();
  const list = all.filter(ev => ids.has(String(ev.id)));
  const wrap = document.getElementById('attendedList'); wrap.innerHTML="";
  if(!list.length){ wrap.innerHTML='<p class="small">å‚åŠ ç™»éŒ²ã—ãŸã‚¤ãƒ™ãƒ³ãƒˆã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚</p>'; return; }
  list.sort((a,b)=>String(a.date).localeCompare(b.date));
  list.forEach(ev=>{
    const f=document.createElement('figure'); f.className='photo';
    f.innerHTML=`
      ${ev.image?`<img src="${ev.image}" alt="">`:`<svg viewBox="0 0 16 9" style="position:absolute;inset:0;width:100%;height:100%"><rect width="16" height="9" fill="#e5e7eb"/></svg>`}
      <figcaption class="overlay">
        <p class="ttl">${ev.title}</p>
        <div class="meta">
          <span class="badge">${ev.category||'ã‚¤ãƒ™ãƒ³ãƒˆ'}</span>
          ${ev.location?`<span class="badge">${ev.location}</span>`:''}
          <span class="badge">${ev.date||''}${ev.time?` ${ev.time}`:''}</span>
        </div>
      </figcaption>
      <a href="#" data-id="${ev.id}" class="open-detail" style="position:absolute;inset:0"></a>
    `;
    wrap.appendChild(f);
  });
}
function updateAttendCount(){
  const n = loadAttend().length;
  document.getElementById('attendCountPill').textContent = `å‚åŠ  ${n}`;
}

/* ================== ä¼šç¤¾æŠ•ç¨¿ ================== */
document.getElementById('submitForm').addEventListener('submit', async e=>{
  e.preventDefault();
  const f=new FormData(e.currentTarget);
  const file=document.getElementById('fileInput').files[0];
  const imgData=file?await new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); }):"";
  const arr=loadEvents();
  arr.push({
    id:Date.now(), title:f.get('title')||'', category:f.get('category')||'',
    organizer:f.get('organizer')||'', date:f.get('date')||'', time:f.get('time')||'',
    location:f.get('location')||'', mode:f.get('mode')||'', price:f.get('price')||'',
    capacity:f.get('capacity')||'', tags:f.get('tags')||'',
    summary:f.get('summary')||'', details:f.get('details')||'',
    applyUrl:f.get('applyUrl')||'', image:imgData, approved:false
  });
  saveEvents(arr);
  alert('é€ä¿¡ã—ã¾ã—ãŸã€‚é‹å–¶å´ã®æ‰¿èªå¾Œã«å…¬é–‹ã•ã‚Œã¾ã™ã€‚');
  e.currentTarget.reset();
});

/* ================== é‹å–¶ï¼ˆãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼‰ ================== */
const pwModal = document.getElementById('pwModal');
const pwInput = document.getElementById('pwInput');
document.getElementById('pwCancel').onclick=()=>{ pwModal.style.display='none'; };
document.getElementById('pwOk').onclick=()=>{
  if(pwInput.value===ADMIN_PASS){
    sessionStorage.setItem(KEY_ADMIN_SESSION, "1");
    pwModal.style.display='none';
    renderAdmin();
  }else{
    alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™');
  }
};
function ensureAdmin(){
  // æ—¢ã«ã‚»ãƒƒã‚·ãƒ§ãƒ³OKãªã‚‰ true
  if(sessionStorage.getItem(KEY_ADMIN_SESSION)==="1"){ return Promise.resolve(true); }
  // å…¥åŠ›ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
  pwInput.value=""; pwModal.style.display='flex';
  // ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã®çµæœã‚’Promiseã§å¾…ã¤
  return new Promise(resolve=>{
    const onHide=()=>{
      pwModal.style.display='none';
      document.removeEventListener('admin-auth-success', onSuccess);
      resolve(sessionStorage.getItem(KEY_ADMIN_SESSION)==="1");
    };
    const onSuccess=()=>{ resolve(true); };
    document.getElementById('pwCancel').addEventListener('click', onHide, {once:true});
    document.getElementById('pwOk').addEventListener('click', ()=>{ if(sessionStorage.getItem(KEY_ADMIN_SESSION)==="1"){ onSuccess(); }}, {once:true});
  });
}

/* ================== é‹å–¶ãƒ†ãƒ¼ãƒ–ãƒ« ================== */
function renderAdmin(){
  document.getElementById('view-admin').style.display='';
  const tbody=document.querySelector('#adminTable tbody'); tbody.innerHTML='';
  loadEvents().sort((a,b)=>String(a.date).localeCompare(b.date)).forEach(ev=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td><input type="checkbox" ${ev.approved?'checked':''} data-act="approve" data-id="${ev.id}"></td>
      <td><strong>${ev.title}</strong><div class="small">ä¸»å‚¬ï¼š${ev.organizer||''}</div>
        <div class="small" style="margin-top:.25rem"><span class="badge">${ev.category||''}</span> <span class="badge">${ev.mode||''}</span></div></td>
      <td>${ev.date||''} ${ev.time||''}</td>
      <td>${ev.location||''}</td>
      <td style="display:flex;gap:.4rem;flex-wrap:wrap">
        <button class="btn" data-act="delete" data-id="${ev.id}">å‰Šé™¤</button>
      </td>`;
    tbody.appendChild(tr);
  });
}
document.getElementById('view-admin').addEventListener('change', e=>{
  const t=e.target;
  if(t.dataset.act==='approve'){
    const arr=loadEvents(); const ev=arr.find(x=>String(x.id)===t.dataset.id);
    if(ev){ ev.approved=t.checked; saveEvents(arr); renderList(); }
  }
});
document.getElementById('view-admin').addEventListener('click', e=>{
  const btn=e.target.closest('button[data-act="delete"]'); if(!btn) return;
  if(!confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
  const arr=loadEvents().filter(x=>String(x.id)!==btn.dataset.id); saveEvents(arr);
  renderAdmin(); renderList();
});

/* ================== åˆæœŸãƒ‡ãƒ¼ã‚¿ & åˆæœŸæç”» ================== */
if(loadEvents().length===0){
  const today=new Date().toISOString().slice(0,10);
  saveEvents([{ id:Date.now()-1, title:"å°±æ´»ã‚¹ã‚¿ãƒ¼ãƒˆãƒ€ãƒƒã‚·ãƒ¥ç›¸è«‡ä¼š", category:"ã‚­ãƒ£ãƒªã‚¢", organizer:"Career Lab",
    date:today, time:"18:00-19:30", location:"ã‚ªãƒ³ãƒ©ã‚¤ãƒ³", mode:"ã‚ªãƒ³ãƒ©ã‚¤ãƒ³",
    price:"ç„¡æ–™", capacity:"å…ˆç€50å", tags:"é¢æ¥,ES,è‡ªå·±åˆ†æ",
    summary:"é¢è«‡ã®ã‚³ãƒ„ã‚„ESæ·»å‰Šãƒã‚¤ãƒ³ãƒˆã‚’Q&Aå½¢å¼ã§ç´¹ä»‹ã€‚", details:"å…ƒãƒ¡ã‚¬ãƒ™ãƒ³å‡ºèº«ãƒ¡ãƒ³ã‚¿ãƒ¼ãŒä¸å¯§ã«è§£èª¬ã€‚",
    applyUrl:"https://example.com/apply", image:"", approved:true }]);
}
renderList();
updateAttendCount();

/* ================== SWç™»éŒ² ================== */
if('serviceWorker' in navigator){ window.addEventListener('load',()=>navigator.serviceWorker.register('./sw.js')); }
</script>
</body>
</html>
