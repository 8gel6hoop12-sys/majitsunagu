<!doctype html>
<html lang="ja"><meta charset="utf-8">
<title>アイコン自動生成（画像1枚でOK）</title>
<style>
  :root{--pri:#2563eb}
  body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;margin:0;background:#f7f9fc;color:#0f172a}
  header{background:#fff;border-bottom:1px solid #e5e7eb;padding:14px 18px;font-weight:800}
  main{max-width:880px;margin:0 auto;padding:18px}
  .zone{border:2px dashed #bfdbfe;background:#f8fbff;border-radius:14px;padding:24px;text-align:center}
  .zone.over{background:#eef6ff}
  .row{margin:14px 0}
  button{background:var(--pri);color:#fff;border:0;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}
  .hint{font-size:.92rem;color:#64748b}
  textarea{width:100%;min-height:160px;border:1px solid #e5e7eb;border-radius:10px;padding:10px;background:#fff}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media(max-width:760px){.grid{grid-template-columns:1fr}}
  .preview{display:grid;grid-template-columns:repeat(6,100px);gap:10px;overflow:auto;padding:6px}
  .tile{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:8px;text-align:center}
  .tile img{width:72px;height:72px;object-fit:cover;border-radius:12px}
  code{background:#eef2ff;padding:2px 6px;border-radius:6px}
</style>
<header>アイコン自動生成ツール（画像1枚でOK / PWA対応）</header>
<main>
  <div class="row zone" id="zone">
    <div style="font-weight:700;margin-bottom:6px">ここに 画像（PNG/JPG/SVG）をドロップ</div>
    <div class="hint">または <input id="file" type="file" accept="image/*,.svg"> を選択</div>
  </div>

  <div class="row">
    <button id="build" disabled>PNGを書き出す（192/512/180/32/16 と maskable）</button>
    <span class="hint">　画像を選ぶと有効になります</span>
  </div>

  <div class="row">
    <div class="preview" id="prev"></div>
  </div>

  <div class="grid">
    <div>
      <h3>生成されるファイル</h3>
      <ul class="hint">
        <li><code>icons/icon-192.png</code>, <code>icons/icon-512.png</code></li>
        <li><code>icons/icon-192-maskable.png</code>, <code>icons/icon-512-maskable.png</code></li>
        <li><code>icons/apple-touch-icon-180.png</code></li>
        <li><code>icons/favicon-32.png</code>, <code>icons/favicon-16.png</code></li>
      </ul>
    </div>
    <div>
      <h3>貼り付け用 manifest.webmanifest</h3>
      <textarea id="manifest" readonly></textarea>
    </div>
  </div>

  <div class="row">
    <h3><code>&lt;head&gt;</code> に入れる <code>&lt;link&gt;</code></h3>
    <textarea id="links" readonly></textarea>
  </div>
</main>

<script>
let loadedImg=null, isSVG=false, svgText="";
const zone=document.getElementById('zone');
const file=document.getElementById('file');
const btn=document.getElementById('build');
const prev=document.getElementById('prev');
const targets=[
  {name:'icon-192.png', w:192, mask:false},
  {name:'icon-512.png', w:512, mask:false},
  {name:'icon-192-maskable.png', w:192, mask:true},
  {name:'icon-512-maskable.png', w:512, mask:true},
  {name:'apple-touch-icon-180.png', w:180, mask:false},
  {name:'favicon-32.png', w:32, mask:false},
  {name:'favicon-16.png', w:16, mask:false}
];

const manifestTpl = () => JSON.stringify({
  name:"マジつなぐ",
  short_name:"マジつなぐ",
  start_url:"./index.html",
  scope:"./", display:"standalone",
  background_color:"#ffffff", theme_color:"#2563eb",
  icons:[
    {src:"./icons/icon-192.png", sizes:"192x192", type:"image/png", purpose:"any"},
    {src:"./icons/icon-512.png", sizes:"512x512", type:"image/png", purpose:"any"},
    {src:"./icons/icon-192-maskable.png", sizes:"192x192", type:"image/png", purpose:"maskable"},
    {src:"./icons/icon-512-maskable.png", sizes:"512x512", type:"image/png", purpose:"maskable"}
  ],
  shortcuts:[
    {name:"イベント投稿", short_name:"投稿", url:"./index.html#submit"},
    {name:"運営ダッシュボード", short_name:"運営", url:"./index.html#admin"}
  ]
}, null, 2);

const linksTpl = `
<link rel="manifest" href="./manifest.webmanifest">
<link rel="icon" type="image/png" sizes="32x32" href="./icons/favicon-32.png">
<link rel="icon" type="image/png" sizes="16x16" href="./icons/favicon-16.png">
<link rel="apple-touch-icon" sizes="180x180" href="./icons/apple-touch-icon-180.png">
<meta name="theme-color" content="#2563eb">`.trim();

function setTextAreas(){
  document.getElementById('manifest').value = manifestTpl();
  document.getElementById('links').value = linksTpl;
}
setTextAreas();

function enable(v){ btn.disabled=!v; }

async function loadFile(f){
  isSVG = f.type.includes('svg') || f.name.endsWith('.svg');
  if(isSVG){
    svgText = await f.text();
    const img = new Image();
    img.src = URL.createObjectURL(new Blob([svgText], {type:'image/svg+xml'}));
    await img.decode();
    loadedImg = img;
  }else{
    const img = new Image();
    img.src = URL.createObjectURL(f);
    await img.decode();
    loadedImg = img;
  }
  enable(true);
  drawPreview();
}

['dragenter','dragover','dragleave','drop'].forEach(ev=>{
  zone.addEventListener(ev, e=>{ e.preventDefault(); e.stopPropagation(); }, false);
});
zone.addEventListener('dragover', ()=> zone.classList.add('over'));
zone.addEventListener('dragleave', ()=> zone.classList.remove('over'));
zone.addEventListener('drop', e=>{
  zone.classList.remove('over');
  const f = e.dataTransfer.files[0]; if(f) loadFile(f);
});
file.addEventListener('change', e=>{ const f=e.target.files[0]; if(f) loadFile(f); });

function paintToCanvas(size, mask){
  // maskable は外周12%の安全域
  const pad = mask ? Math.round(size*0.12) : 0;
  const W=size, H=size, s = Math.min(W-2*pad, H-2*pad);
  const canvas = document.createElement('canvas'); canvas.width=W; canvas.height=H;
  const ctx = canvas.getContext('2d');
  ctx.clearRect(0,0,W,H);
  ctx.drawImage(loadedImg, pad, pad, s, s);
  return canvas;
}
function download(name, dataURL){
  const a=document.createElement('a'); a.href=dataURL; a.download=name; a.click();
}
function drawPreview(){
  prev.innerHTML="";
  for(const t of targets){
    const c = paintToCanvas(t.w, t.mask);
    const tile=document.createElement('div'); tile.className='tile';
    tile.innerHTML=`<div style="font-size:.8rem;margin-bottom:6px">${t.name}</div>`;
    const img=document.createElement('img'); img.src=c.toDataURL('image/png');
    tile.appendChild(img); prev.appendChild(tile);
  }
}

btn.addEventListener('click', ()=>{
  if(!loadedImg) return;
  // 画像群
  for(const t of targets){
    const c = paintToCanvas(t.w, t.mask);
    download(`icons/${t.name}`, c.toDataURL('image/png'));
  }
  // manifest と linkメモ
  const man = new Blob([manifestTpl()], {type:'application/json'});
  const a1 = document.createElement('a'); a1.href=URL.createObjectURL(man); a1.download='manifest.webmanifest'; a1.click();
  const linkTxt = new Blob([linksTpl], {type:'text/plain'});
  const a2 = document.createElement('a'); a2.href=URL.createObjectURL(linkTxt); a2.download='HEAD-links.txt'; a2.click();
  alert('ダウンロード完了：icons/ フォルダに保存し、manifestと<head>のlinkを反映してください。');
});
</script>
